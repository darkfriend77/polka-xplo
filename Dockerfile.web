FROM node:20-slim AS build
WORKDIR /app

# Copy root workspace config
COPY package.json turbo.json tsconfig.base.json .npmrc ./

# Copy all workspace package.json files for dependency resolution
COPY packages/shared/package.json ./packages/shared/
COPY packages/db/package.json ./packages/db/
COPY packages/indexer/package.json ./packages/indexer/
COPY packages/web/package.json ./packages/web/
COPY extensions/pallet-staking/package.json ./extensions/pallet-staking/

# Install all dependencies (workspaces need the full graph)
RUN npm install

# Copy source code
COPY packages/shared/ ./packages/shared/
COPY packages/web/ ./packages/web/
COPY extensions/ ./extensions/
COPY chain-config.json ./

# Build shared first (web depends on it)
RUN npx tsc -p packages/shared/tsconfig.json

# Accept chain ID as a build argument so NEXT_PUBLIC_ env is inlined at build time
ARG NEXT_PUBLIC_CHAIN_ID=polkadot
ENV NEXT_PUBLIC_CHAIN_ID=$NEXT_PUBLIC_CHAIN_ID

# Build the Next.js frontend
ENV NEXT_TELEMETRY_DISABLED=1
RUN cd packages/web && npx next build

# --- Production stage ---
FROM node:20-slim AS runner
WORKDIR /app

ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1

# Copy the standalone output (includes minimal node_modules)
COPY --from=build /app/packages/web/.next/standalone ./
# Copy static assets (not included in standalone)
COPY --from=build /app/packages/web/.next/static ./packages/web/.next/static
# Copy public/ folder for favicon, images, and other static assets
COPY --from=build /app/packages/web/public ./packages/web/public

EXPOSE 3000

# The standalone server.js is at the web package path within the monorepo mirror
CMD ["node", "packages/web/server.js"]
